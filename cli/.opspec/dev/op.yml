name: dev
description: compiles and exposes a delv debugger for the cli
inputs:
  dockerSocket:
    socket:
      description: docker socket to use as container runtime
  GOCACHE:
    dir:
      description: https://golang.org/cmd/go/#hdr-Build_and_test_caching
      default: /../../../.go/cache
  GOPATH:
    dir:
      description: https://golang.org/cmd/go/#hdr-GOPATH_environment_variable
      default: /../../../.go/path
run:
  serial:
    - op:
        ref: ../compile
    - container:
        image: { ref: 'golang:1.15' }
        cmd:
          - go
          - run
          - github.com/go-delve/delve/cmd/dlv
          - --listen=:40000
          - --headless=true
          - --api-version=2
          - exec
          - ./opctl-linux-amd64
          - run
          - github.com/opspec-pkgs/uuid.v4.generate#1.1.0
        dirs:
          /src: $(../../..)
          /go/pkg: $(GOPATH/pkg)
          /root/.cache/go-build: $(GOCACHE)
        ports:
          # debug port for delve
          40000: 40000
        sockets:
          /var/run/docker.sock: $(dockerSocket)
        workDir: /src
