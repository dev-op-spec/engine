(window.webpackJsonp=window.webpackJsonp||[]).push([[28],{168:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return i})),n.d(t,"metadata",(function(){return s})),n.d(t,"rightToc",(function(){return l})),n.d(t,"default",(function(){return u}));var a=n(1),r=n(9),o=(n(0),n(214)),i={title:"Run a go service",sidebar_label:"run a go service"},s={id:"run-a-go-service",title:"Run a go service",description:"We'll now look at an op to run a sample Go application. Please see the code at [https://github.com/opctl/opctl/tree/master/examples/run-a-go-service](https://github.com/opctl/opctl/tree/master/examples/run-a-go-service)",source:"@site/docs/run-a-go-service.md",permalink:"/docs/run-a-go-service",editUrl:"https://github.com/opctl/opctl/edit/master/website/docs/run-a-go-service.md",lastUpdatedBy:"Chris Dostert",lastUpdatedAt:1578700982,sidebar_label:"run a go service",sidebar:"docs",previous:{title:"Inputs & Outputs",permalink:"/docs/training/inputs-outputs"},next:{title:"Run a react app",permalink:"/docs/run-a-react-app"}},l=[],c={rightToc:l},p="wrapper";function u(e){var t=e.components,n=Object(r.a)(e,["components"]);return Object(o.b)(p,Object(a.a)({},c,n,{components:t,mdxType:"MDXLayout"}),Object(o.b)("p",null,"We'll now look at an op to run a sample Go application. Please see the code at ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://github.com/opctl/opctl/tree/master/examples/run-a-go-service"}),"https://github.com/opctl/opctl/tree/master/examples/run-a-go-service"),"\nThe sample application we have requires a mysql database, therefore to run it locally we need to:\n1. Start a MySQL database with some DB credentials\n2. (optional) Seed the DB with sample data\n3. Start the application and provide the MySQL DB credentials as inputs - our application will read those from environment variables"),Object(o.b)("p",null,"The ops to make that happen are explained below."),Object(o.b)("h4",{id:"mysql"},"mysql"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-yaml"}),"name: mysql\ndescription: runs a mysql container, optionally seeding it with sample data\ninputs:\n  MYSQL_USER:\n    string:\n      default: testuser\n      description: username for MySQL user to create\n  MYSQL_PASSWORD:\n    string:\n      default: testpassword\n      description: password for MySQL user to create\n  MYSQL_DATABASE:\n    string:\n      default: testapp\n      description: Database to create\n  MYSQL_HOST:\n    string:\n      default: mysql\n  doSeed:\n    boolean:\n      default: false\n      description: if true, sample data will be inserted in the database\nrun:\n  parallel:\n    - container:\n        image: { ref: 'mysql:8' }\n        name: mysql # this value will be provided as input to the 'local' op so our code knows what mysql host to connect to\n        envVars: {MYSQL_USER , MYSQL_PASSWORD , MYSQL_DATABASE , MYSQL_RANDOM_ROOT_PASSWORD: \"yes\"}\n        ports: { '3306': '3306' }\n    - container:\n        image: { ref: 'mysql:8' }\n        envVars: {MYSQL_USER, MYSQL_PASSWORD, MYSQL_HOST, MYSQL_DATABASE, doSeed}\n        files:\n          /seed.sql: # this shorthand form will copy seed.sql from the root of this op to the root of the container\n        workDir: /db\n        cmd: \n          - sh\n          - -ce\n          - |\n            echo \"starting seed script\"\n            sleep 25 # we'll sleep while the MySQL DB starts\n            if [ $doSeed = \"true\" ]\n            then\n              echo \"connecting to load sql script\"\n              mysql -u $MYSQL_USER -p$MYSQL_PASSWORD -h $MYSQL_HOST $MYSQL_DATABASE < /seed.sql\n            fi\n            exit 0\n")),Object(o.b)("p",null,"This op will run a MySQL database in a Docker container. It has an optional input, ",Object(o.b)("inlineCode",{parentName:"p"},"doSeed"),", which is of type ",Object(o.b)("inlineCode",{parentName:"p"},"Boolean"),". When ",Object(o.b)("inlineCode",{parentName:"p"},"true"),", it will run the ",Object(o.b)("inlineCode",{parentName:"p"},"seed.sql")," script in a second, parallel container to seed the MySQL database in first container with a single table and a single row of data."),Object(o.b)("p",null,"Note that instead of writing the ",Object(o.b)("inlineCode",{parentName:"p"},"cmd")," inline, we could have also put the run script in a file in the op directory and referenced it.\ne.g."),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-yaml"}),'cmd: ["/run.sh"]\n')),Object(o.b)("p",null,"This becomes useful for readability if the script we're running in a container is large."),Object(o.b)("p",null,"Note that while we could have also built a custom docker image that contains that script and ran it, that's not a recommended practice. While the op remains portable with that approach, it is less transparent and harder to maintain, since we would have the extra step of building and pushing that image whenever we make a change to the script. Instead, we usually opt for the leanest Docker image that fulfills our use case, and include any scripts or binaries we need in the op directory."),Object(o.b)("h4",{id:"dev"},"dev"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-yaml"}),"name: dev\ndescription: runs go-svc for development\ninputs:\n  MYSQL_USER:\n    string:\n      default: testuser\n      description: username for MySQL user to create\n  MYSQL_PASSWORD:\n    string:\n      default: testpassword\n      description: password for MySQL user to create\n  MYSQL_DATABASE:\n    string:\n      default: testapp\n      description: Database to create\n  MYSQL_HOST:\n    string:\n      default: mysql # the host for mysql is the container name in the mysql op\nrun:\n  parallel:\n    - op:\n        ref: ../mysql # we reference the mysql op using its relative path to this op\n        inputs: { MYSQL_USER, MYSQL_PASSWORD, MYSQL_HOST, MYSQL_DATABASE, doSeed: true} # we pass the relevant inputs through to the mysql op\n    - container:\n        image: { ref: 'golang:1.10.3' }\n        name: go-svc\n        dirs:\n          /go/src/github.com/golang-ops-example: $(/app) # IMPORTANT: we've created a symlink in the root of the op (i.e. at /.opspec/dev) to the source code of our app (i.e. at /app) - this is so we can encapsulate the op, meaning that any files the op needs to reference now are accessible from within its directory. we reference that symlink here as /app because that refers to the root of the op - see https://opctl.io/docs/reference/op-definition-format/op.yml/expressions/dir-entry-ref.html#embedded-json-file for more details\n        envVars: {MYSQL_USER, MYSQL_PASSWORD, MYSQL_HOST, MYSQL_DATABASE} # the same inputs are needed to let our code know how to connect to the DB\n        workDir: /go/src/github.com/golang-ops-example\n        ports: { '8080': '8080' }\n        cmd:\n          - sh\n          - -ce\n          - |\n            go get -u github.com/cespare/reflex # get reflex to watch and hot-reload our main.go\n            sleep 30 # we'll sleep while the MySQL DB starts\n            /go/bin/reflex -g 'main.go' -s -- sh -c 'go run main.go'\n")),Object(o.b)("p",null,"This op will do the following, in parallel:\n1. Run the mysql op, passing in the inputs needed to create it\n2. run our service in the ",Object(o.b)("inlineCode",{parentName:"p"},"golang")," container. We'll use ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://github.com/cespare/reflex"}),"reflex")," to make development easier and avoid having to restart the whole operation after every change to main.go"),Object(o.b)("p",null,"Now to run the service locally, we only run ",Object(o.b)("inlineCode",{parentName:"p"},"opctl run dev")),Object(o.b)("p",null,"Notice how we can run ops in a ",Object(o.b)("inlineCode",{parentName:"p"},"parallel")," block. Our app runs parallel to the MySQL DB container (via the ",Object(o.b)("inlineCode",{parentName:"p"},"mysql")," op), because we need mysql running while our app runs."))}u.isMDXComponent=!0},214:function(e,t,n){"use strict";n.d(t,"a",(function(){return u})),n.d(t,"b",(function(){return b}));var a=n(0),r=n.n(a);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var c=r.a.createContext({}),p=function(e){var t=r.a.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):s({},t,{},e)),n},u=function(e){var t=p(e.components);return(r.a.createElement(c.Provider,{value:t},e.children))},d="mdxType",h={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},m=Object(a.forwardRef)((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,i=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),u=p(n),d=a,m=u["".concat(i,".").concat(d)]||u[d]||h[d]||o;return n?r.a.createElement(m,s({ref:t},c,{components:n})):r.a.createElement(m,s({ref:t},c))}));function b(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,i=new Array(o);i[0]=m;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[d]="string"==typeof e?e:a,i[1]=s;for(var c=2;c<o;c++)i[c]=n[c];return r.a.createElement.apply(null,i)}return r.a.createElement.apply(null,n)}m.displayName="MDXCreateElement"}}]);